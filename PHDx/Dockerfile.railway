FROM python:3.11-slim

WORKDIR /app

# Set default PORT (Railway overrides this at runtime)
ENV PORT=8000

# Install production dependencies for FastAPI backend
# Includes toml and langchain packages required by llm_gateway.py
RUN pip install --no-cache-dir \
    fastapi \
    uvicorn \
    pydantic \
    python-docx \
    google-auth \
    google-auth-oauthlib \
    google-api-python-client \
    anthropic \
    openai \
    toml \
    langchain \
    langchain-anthropic \
    langchain-openai \
    langchain-core \
    python-dotenv \
    requests

# Copy only necessary files from PHDx directory
COPY PHDx/api/ ./api/
COPY PHDx/core/ ./core/

# Create backups directory
RUN mkdir -p backups

EXPOSE 8000

# Railway sets PORT at runtime, use it directly
CMD ["sh", "-c", "python -m uvicorn api.server:app --host 0.0.0.0 --port $PORT"]
